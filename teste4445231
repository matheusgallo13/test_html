def organize_and_remove_duplicates(df):
    """
    Organiza os registros no DataFrame e remove duplicados dos tipos 'contracts' 
    e 'communication_letter', mantendo apenas o último elemento por 'line' de cada tipo.
    """
    # Ordenar os registros por 'register_id' e 'line' de forma crescente
    df = df.sort_values(by=['register_id', 'line'], ascending=[True, True])
    
    # Remover duplicados para 'contracts' e 'communication_letter', mantendo o último por 'line'
    df = df.groupby(['register_id', 'type'], group_keys=False).apply(
        lambda group: group.sort_values('line', ascending=False).head(1)
    )
    
    # Organizar o DataFrame novamente pela 'register_id' e 'line'
    df = df.sort_values(by=['register_id', 'line'], ascending=[True, True])

    # Retornar o DataFrame organizado, com as colunas originais
    return df[['filename', 'register_id', 'line', 'type', 'file', 'bytesIO']]
