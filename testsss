import pytest
from unittest.mock import MagicMock, patch
import io
from your_module import DataMergeFilesHTMLUseCase  # Importe a classe corretamente do seu código

class TestDataMergeFilesHTMLUseCase:
    
    @pytest.fixture
    def use_case(self):
        # Setup: Criação de uma instância da sua classe
        return DataMergeFilesHTMLUseCase()

    @patch('your_module.Environment')  # Mock do ambiente Jinja2
    @patch('your_module.getcwd')       # Mock da função os.getcwd()
    def test_init(self, mock_getcwd, mock_jinja, use_case):
        # Simula valores retornados pelos mocks
        mock_getcwd.return_value = "/mock/path"
        mock_jinja.return_value = MagicMock()

        # Testa se o init foi configurado corretamente
        assert use_case.path_templates == '/mock/path/domain/use_cases/templates'
        assert use_case.path_logo_1 == '/mock/path/domain/use_cases/templates/logo_1.png'
        assert use_case.path_logo_2 == '/mock/path/domain/use_cases/templates/logo_2.png'

    @patch('your_module.datetime')  # Mock do datetime
    def test_build_html_active_annotations(self, mock_datetime, use_case):
        # Mock para a função datetime
        mock_datetime.now.return_value.strftime.return_value = "12/09/2024"
        
        json_data = {
            "documento": "doc1",
            "detalhes": "det1",
            "grafias": "graf1"
        }
        
        # Simula o render dos templates no Jinja2
        use_case.template_active_annotations.render = MagicMock(return_value="HTML Rendered")

        # Chama o método que estamos testando
        result = use_case.build_html_active_annotations(json_data)
        
        # Verifica se o render foi chamado com os parâmetros corretos
        use_case.template_active_annotations.render.assert_called_once_with(
            documento='doc1',
            detalhes='det1',
            grafias='graf1',
            now="12/09/2024"
        )
        
        # Verifica o resultado final
        assert result == "HTML Rendered"
    
    def test_convert_html_to_pdf_success(self, use_case):
        input_html = "<html><body>Test</body></html>"
        
        # Mock do buffer PDF e do pisa
        pdf_buffer = io.BytesIO()
        with patch('your_module.pisa.CreatePDF', return_value=(True, pdf_buffer)):
            result = use_case.convert_html_to_pdf(input_html)
            
            # Verifica se o método retornou o buffer corretamente
            assert result == pdf_buffer
    
    def test_convert_html_to_pdf_failure(self, use_case):
        input_html = "<html><body>Test</body></html>"
        
        # Simula erro na conversão do PDF
        with patch('your_module.pisa.CreatePDF', return_value=(False, None)):
            result = use_case.convert_html_to_pdf(input_html)
            
            # Verifica se o resultado foi None em caso de erro
            assert result is None
